# ROS功能包：二维栅格地图生成

## change_log

### 2023-07-03

1. 加长点云队列长度，加长ros监听tf缓冲区时间长度。但是，如果里程计无法做到实时，缓冲区迟早会满，因此这个改动不是很有必要，而且在播放包测试情况下，检查tf时间戳由于会调用ros::time::now，时间戳会出问题，因此除了修改点云队列长度限制外，其他的先注释调了（合并到slam 1.1.5版本）。




## 介绍

以在线（ros话题）或离线（点云文件）的方式生成二维栅格地图，地图以四叉树结构来存储。

在线生成接收点云话题和指明其位置的里程计话题或tf，离线生成读取每一帧点云的pcd文件和对应的位姿数据文件。

读取的点云数据保留一定高度（z轴）范围内的点，生成二维点云，认为扫描点所在的栅格被占据，认为传感器原点到扫描点之间光线穿过的栅格为空闲。

以四叉树构建二维栅格地图，以概率更新的方式更新每个栅格占据值，发布生成的栅格地图话题。（有一定的去除动态障碍物的效果）

## 参数配置

config/param.yaml

> 配置文件夹路径、接收的话题名、生成地图的参数等等

launch/occupancy_mapping.launch
> 修改在线或离线读取文件生成的方式

## 运行

'''
source devel/setup.bash
'''

读取点云文件离线生成：
'''
roslaunch occupancy_mapping occupancy_mapping.launch
'''

发布map：
'''
rosservice call /occupancy_mapping_node/publish_occupancy_map
'''

## 详细介绍

### 输入输出数据

#### 输入

**离线生成**
1. 每一帧点云的pcd文件（需分帧保存并编号）；
2. 保存每一帧点云相对于固定坐标系（map）的位姿数据的txt文件（文件中每一行代表对应行数文件名的pcd点云的位姿，为齐次变换矩阵前三行）；


**在线生成：**

1. 点云ros消息，如/velodyne_points 或slam算法过程中的中间去畸变的点云消息（需以传感器为坐标系）；
2. 里程计话题/tf消息（可选）。

#### 输出

1. 二维栅格地图ros消息；
2. laserscan二维点云话题。

### 四叉数地图

#### 节点属性

1. 层级：最低层（栅格size等于最终地图分辨率的层）为0层，层级每+1,该层栅格size×2
2. 占据概率的log值：表明该栅格被占据与否
3. 栅格位置：栅格左下角的栅格化坐标（以x轴正向向右，y轴正向向上）
4. 四个子节点指针

### 相关函数

1. 更新栅格：更新输入坐标下的栅格占据概率值
2. 扩增地图：扩增四叉树节点使其范围包含输入坐标栅格
3. 寻找子节点：寻找输入栅格在本节点的哪个子节点范围内